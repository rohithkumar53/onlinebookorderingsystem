const Book= require('../models/bookModel');


exports.findBooks= async (req, res) =>{
    try {
        const books = await Book.find({});
        if(!books){
            return res.status(406).json({message: "No books present!!"});
        }
        else{
            return res.send(books);
        }
    } catch (error) {
        return res.status(400).json({error: error});
    }

}

exports.findBookById= async (req, res)=>{
    try {
        const id= req.params.bookid;
        const book= await Book.findById(id);
        if(!book){
            return res.status(406).json({message: "No book found with that ID!!"})
        }
        else{
            res.send(book);
        }
    } catch (error) {
        return res.status(400).json({error: error});
    }
}

exports.addreview= async (req, res)=> {
    try {
        const {reviewobj, bookid, activeUser}= req.body;
        const book= await Book.findById(bookid);
        const review = {
            userid: activeUser._id,
            name: activeUser.name,
            rating: reviewobj.rating,
            comment: reviewobj.review
        }

        // first we are pushing the review to the reviews array
        book.reviews.push(review);
        
        // now we have to loop through reviews array to calculate the overall rating
        let ratingrevised=0;
        book.reviews.forEach(eachreview => {
            ratingrevised=eachreview.rating+ ratingrevised;
        });
        ratingrevised= ratingrevised/ book.reviews.length;

        //now we assign the calculated overall rating to the rating 
        book.rating=ratingrevised;

        book.save().then(boo => {
            return res.send("Your review saved and submitted successfully!!!");
        }).catch(error => res.status(400).json({message: "Review not submitted, something went wrong!!"}));
    } catch (error) {
        return res.status(400).json({error: error});
    }
}